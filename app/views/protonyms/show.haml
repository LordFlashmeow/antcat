-title "#{@protonym.name.name} - Protonyms"
-breadcrumb :protonym, @protonym

-content_for :breadcrumbs_right do
  -if user_is_at_least_helper?
    =link_to 'Edit', edit_protonym_path(@protonym), class: "btn-normal"
  -if current_user
    =link_to "History", protonym_history_path(@protonym), class: "btn-normal"
    =link_to "What Links Here", protonym_what_links_here_path(@protonym), class: "btn-normal"
  -if user_is_at_least_helper?
    -if !@protonym.taxa.exists?
      =link_to "Delete", protonym_path(@protonym), method: :delete, data: { confirm: 'Are you sure?' }, class: "btn-warning"

  -if current_user
    .btn-normal.dropdown.button{data: { toggle: "more-dropdown"}, type: "button"} More
    #more-dropdown.dropdown-pane{data: { dropdown: 'true', hover: 'true', hover_pane: 'true' }}
      %ul.no-bullet
        -if user_is_at_least_helper?
          %li=link_to "Move items", new_protonym_move_items_path(@protonym), class: "btn-normal"
        %li=link_to "Soft validations", protonym_soft_validations_path(@protonym), class: "btn-normal"
        %li=activities_link_for_trackable @protonym

-if Settings.catalog.show_failed_soft_validations
  -if current_user && @protonym.soft_validations.failed?
    .row.margin-bottom
      .medium-9.columns
        .soft-validations-callout.callout.warning
          %h6 Issues (#{link_to("see more", protonym_soft_validations_path(@protonym))})
          =render 'shared/failed_soft_validations', soft_validations: @protonym.soft_validations

.row.margin-bottom
  .small-9.columns
    %h5
      Protonym:
      =@protonym.decorate.name_with_fossil
      -if @protonym.sic?
        [sic]
      -if @protonym.nomen_nudum?
        %i
          =ndash
          nomen nudum
      -if current_user
        .right=link_to "Name record ##{@protonym.name.id}", name_path(@protonym.name), class: 'btn-normal btn-tiny'
    %table.table.unstriped
      %tbody
        %tr
          %th Authorship
          %td
            =succeed ':' do
              =@protonym.authorship_reference.decorate.expandable_reference
            =@protonym.authorship.pages

        -# TODO: Most of these *should* only be set for `SpeciesGroupTaxon`s.
        -if @protonym.forms?
          %tr
            %th Forms
            %td=@protonym.forms
        -if @protonym.biogeographic_region?
          %tr
            %th Biogeographic region
            %td=@protonym.biogeographic_region
        -if @protonym.locality?
          %tr
            %th Locality
            %td=@protonym.decorate.format_locality

        -if @protonym.ichnotaxon?
          %tr
            %th Ichnotaxon
            %td Yes

        -if (type_name = @protonym.type_name)
          %tr
            %th Type name
            %td
              -type_name_decorated = type_name.decorate
              =type_name_decorated.format_rank
              =CatalogFormatter.link_to_taxon(type_name.taxon) + type_name_decorated.compact_taxon_status + Detax[type_name_decorated.format_fixation_method]

        -if current_user && (format_nomen_attributes = @protonym.decorate.format_nomen_attributes)
          %tr.logged-in-only-background
            %th
              Nomen attributes (beta)
              =logged_in_only_tooltip_icon
            %td=format_nomen_attributes

        -if @protonym.etymology_taxt?
          %tr
            %th Etymology
            %td=Detax[@protonym.etymology_taxt]

        -if @protonym.primary_type_information_taxt?
          %tr
            %th Primary type information
            %td=::Types::FormatTypeField[@protonym.primary_type_information_taxt]
        -if @protonym.secondary_type_information_taxt?
          %tr
            %th Secondary type information
            %td=::Types::FormatTypeField[@protonym.secondary_type_information_taxt]
        -if @protonym.type_notes_taxt?
          %tr
            %th Type notes
            %td=::Types::FormatTypeField[@protonym.type_notes_taxt]
        -if @protonym.notes_taxt?
          %tr
            %th Notes
            %td=Detax[@protonym.notes_taxt]

  -if current_user
    .medium-3.columns
      .additional-editor-data.callout.no-border-callout.logged-in-only-background
        %h6=@protonym.name.epithet_html

        =render 'protonyms/shared/additional_data_for_editors', protonym: @protonym

        -if user_is_at_least_helper?
          =link_to "Add history item", new_protonym_history_item_path(@protonym, **current_page_redirect_back_url), class: "btn-normal btn-tiny"

      -# TODO: Pass gender from protonym once it has been moved from `Name`s belonging to taxa.
      =render 'protonyms/shared/etymology_and_gender', protonym: @protonym, taxon: nil

-if @protonym.taxa.present?
  .row.margin-bottom
    .small-12.columns
      %h5 Taxa belonging to this protonym
      %table
        -TaxonQuery.new(@protonym.taxa.order_by_name).with_common_includes_and_current_taxon_includes.each do |taxon|
          %tr
            %td=CatalogFormatter.link_to_taxon(taxon)
            %td=taxon.rank.capitalize
            %td
              =taxon.status.capitalize
              -unless taxon.status.in?(Taxa::ExpandedStatus::SELF_STATUSES)
                %br
                %small=taxon.decorate.expanded_status
            %td
              -if taxon.original_combination?
                Original combination
                =antcat_icon 'check'
            -if current_user
              %td
                =taxon.decorate.link_to_antwiki
                %br
                =link_to "Show children", taxa_children_path(taxon), class: "btn-normal btn-tiny"

-if current_user
  -content_for :javascripts do
    =javascript_include_tag 'markdown_and_friends', 'taxt_editor'
    =javascript_include_tag 'reference_select'
    =javascript_include_tag 'taxon_select'
    =javascript_include_tag 'protonym_select'
    =javascript_include_tag 'jquery-ui/widgets/draggable', 'jquery-ui/widgets/sortable'
    =javascript_include_tag 'controllers/protonyms/reorder_history_items'
  =render "shared/default_reference"
  =render 'protonyms/quick_edit_history_items', protonym: @protonym
