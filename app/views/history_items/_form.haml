-content_for :javascripts do
  =javascript_include_tag 'markdown_and_friends', 'taxt_editor'

=render "shared/default_reference"

=form_with model: history_item, scope: :history_item, url: url do |f|
  =render "shared/errors_for", resource: history_item

  .row
    .medium-12.columns
      =text_area_tag :taxt, history_item.taxt, rows: 5, name: 'history_item[taxt]',
        data: { has_linkables: true, previewable: true, previewable_title: "History item", use_extras: true }

  .row
    .medium-3.columns.end
      Show only for rank:
      =f.select :rank, Rank::AntCatSpecific::TYPE_SPECIFIC_HISTORY_ITEM_TYPES, include_blank: 'All ranks (default)'

  .row
    .medium-3.columns.end
      =edit_summary_text_field_tag

  .row
    .medium-3.columns.end
      =f.button 'Save', class: "btn-saves"

%h5.huge-margin-top.small-margin-bottom Related records

-# TODO: DRY w.r.t. 'history_items/show.haml'.
-if protonym.taxa.present?
  .row.margin-bottom
    .small-12.columns
      %h6.bold Taxa belonging to this history item's protonym
      %table
        -TaxonQuery.new(protonym.taxa.order_by_name).with_common_includes_and_current_taxon_includes.each do |taxon|
          %tr
            %td=CatalogFormatter.link_to_taxon(taxon)
            %td=taxon.rank.capitalize
            %td
              =taxon.status.capitalize
              -unless taxon.status.in?(Taxa::ExpandedStatus::SELF_STATUSES)
                %br
                %small=taxon.decorate.expanded_status

%h6.bold.small-margin-bottom Other history items belonging to #{protonym.name.name_html}
%table
  %tbody
    -if protonym.history_items.persisted.empty?
      %tr
        %td{colspan: 2} Protonym has no history items.
    -else
      -protonym.history_items.persisted.each do |protonym_history_item|
        %tr{class: ('pale-background' if protonym_history_item == history_item)}
          %td
            =link_to "##{protonym_history_item.id}", history_item_path(protonym_history_item)
            -if protonym_history_item == history_item
              %strong (selected)
          %td.grow
            %small=Detax[protonym_history_item.to_taxt]
